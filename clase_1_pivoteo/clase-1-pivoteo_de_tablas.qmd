---
title: "OptimizaciÃ³n de Tablas y Transformaciones Avanzadas"
subtitle: "Tratamiento de datos II"
format:
  revealjs: 
    slide-number: true
    code-copy: true
    code-tools: true
    incremental: true
    execute:
      echo: true
    highlight-style: atom-one-light
    chalkboard: 
      buttons: true
    preview-links: auto
    logo: img/logo_estacionr.png
    #css: styles.css
resources:
  - demo.pdf
---

```{r}
#| echo: false
#| message: false
#| warning: false

options(scipen = 999)

### Cargo librerÃ­as
library(dplyr)
library(janitor)
library(magrittr)
library(readr)

### Cargo dataset
df_ingresos_orig <- read_csv(here::here("data/base_personas_ingreso_anual_2024.csv"))
```


# Bienvenidos y bienvenidas a EstaciÃ³n R

::: columns
::: {.column width="33%"}
ğŸ’¬ [Slack](https://estacion-r.slack.com/archives/C08QB32P8S1)

ğŸ”— [Web](https://estacion-r.com)

âœ‰ï¸ [Correo](mailto:pablotiscornia@estacion-r.com)
:::


::: {.column width="33%"}
ğŸ˜ [Mastodon](https://mastodon.social/@pablote)

ğ• [X](https://twitter.com/estacion_erre)
:::

::: {.column width="33%"}
[in] [LinkedIn](https://www.linkedin.com/company/estacion-r/)

[ig] [Instagram](https://instagram.com/estacion.erre)
:::
:::


## Hoja de Ruta - MÃ³dulo I 

<br>

ğŸ“Œ  OptimizaciÃ³n de Tablas y Transformaciones Avanzadas

<br>

::: columns
::: {.column width="50%"}
ğŸ“¦ Paquete `{dplyr}`

```         
ğŸ”§ distinct() 
ğŸ”§ pull() 
ğŸ”§ relocate()
ğŸ”§ coalesce() 
ğŸ”§ na_if() 
ğŸ”§ slice()
```
:::

::: {.column width="50%"}
ğŸ“¦ Paquete `{tidyr}`

```         
ğŸ”§ pivot_longer() 
ğŸ”§ pivot_wider() 
```


ğŸ“¦ Paquete `{janitor}`

```         
ğŸ”§ clean_names() ğŸ”§ tabyll()  
```
:::
:::



## ConfiguraciÃ³n para esta clase

<br>

::: incremental
- âœ… Armar un proyeto de trabajo 

- âœ… Crear una carpeta llamada `datos`

- âœ… Descargar la base de [**Ingreso de anual de Personas 2024 - MX**](https://github.com/Estacion-R/dominando_r/blob/main/data/base_personas_ingreso_anual_2024.csv) y ubicarla en la carpeta `datos`

- âœ… Crear un **script** de trabajo
:::


## ConfiguraciÃ³n para esta clase

- CÃ³digo para cargar la base directo desde Github, sin tener que descargarla (se necesita conexiÃ³n a internet)

<br>

```{r}
#| echo: true
#| eval: false
library(readr)

### Cargo base de trabajo
valor_ruta <- "https://raw.githubusercontent.com/Estacion-R/dominando_r/main/data/base_personas_ingreso_anual_2024.csv"

df_ingresos_orig <- read_csv(valor_ruta)
```


## Procesamiento de datos - Mapa

![](../img/circuito del dato.png)


## Procesamiento de datos - La pipa (o tuberÃ­a)

<br>
  
-  EL PIPE 

![](../img/pipe.png)
- > Una forma de escribir


## Procesamiento de datos - La pipa (o tuberÃ­a)

<br><br>

::: columns
::: {.column width="50%"}
```{r eval = F}
base_de_datos `%>%`
  funcion1 `%>%` 
  funcion2 `%>%` 
  funcion3
```
:::

::: {.column width="50%"}

![](../img/pipe_paso_a_paso.gif)
:::
:::

## Procesamiento de datos - Buenas prÃ¡cticas {.smaller .scrollable transition="slide"}

<br><br>

::: incremental
-   Diagnosticar
-   Procesar
-   Chequear
:::


## Procesamiento de datos - Buenas prÃ¡cticas {.smaller .scrollable transition="slide"}

- Ejemplo: Nombre de columnas


::: panel-tabset

### Diagnosticar

```{r}
#| echo: true

colnames(df_ingresos_orig)
```

### Procesar

```{r}
#| echo: true

library(janitor)

df_ingresos_trab <- df_ingresos_orig %>% 
  clean_names()
```

### Chequear

```{r}
colnames(df_ingresos_trab)
```
:::


## Procesamiento de datos - Buenas prÃ¡cticas {.smaller .scrollable transition="slide"}

- Ejemplo: CategorÃ­as de una variable

::: panel-tabset
### Diagnosticar

```{r}
unique(df_ingresos_trab$ciudad_residencia)
```

<br>

```{r}
length(unique(df_ingresos_trab$ciudad_residencia))
```

### Procesar

```{r}
library(dplyr)
library(stringr)

df_ingresos_trab <- df_ingresos_trab %>% 
  mutate(
    ciudad_residencia = str_to_lower(ciudad_residencia),
    ciudad_residencia = str_to_sentence(ciudad_residencia))
```

### Chequear

```{r}
unique(df_ingresos_trab$ciudad_residencia)
```

<br>

```{r}
length(unique(df_ingresos_trab$ciudad_residencia))
```
:::

## Pregunta {.smaller}

<br>

ğŸ—³ Votar: Â¿QuÃ© hace la funciÃ³n `str_to_title()`?

```{r}
str_to_title(c("pepe Locura", "Rodobolfo Lanzini", "lola lala"))
```

<br>

- ğ€ --> Agrega una mayÃºscula a la primera letra de la primera palabra
- ğ --> Agrega una mayÃºscula a la primera letra de todas las palabras
- ğ‚ --> Pasa todo a minÃºscula


## Procesamiento de datos

ğŸ“š Kit de funciones:

<br>

ğŸª› `janitor::clean_names()`: _Simplifica y estandariza nombres de columnas._

ğŸª› `dplyr::distinct()`: _Filtra y mantiene solo filas Ãºnicas segÃºn variables especÃ­ficas._

ğŸª› `dplyr::pull()`: _Extrae una columna como vector._


## Procesamiento de datos

ğŸ“š Kit de funciones:

<br>

ğŸª› `dplyr::coalesce()`: _Ayuda a manejar valores faltantes reemplazÃ¡ndolos con valores especÃ­ficos._

ğŸª› `dplyr::na_if()`: _Convierte valores especÃ­ficos (por ejemplo valores errÃ³neos) a NA._

ğŸª› `dplyr::slice()`: _Selecciona subconjuntos especÃ­ficos de filas segÃºn su posiciÃ³n._


## Procesamiento de datos

<br>

ğŸª› `distinct()`: _Filtra y mantiene solo filas Ãºnicas segÃºn variables especÃ­ficas._

```{r}
### DiagnÃ³stico
# Identifico si existen casos duplicados
df_duplicados <- df_ingresos_trab %>% 
  get_dupes()

head(df_duplicados, n = 3)
```

## Procesamiento de datos

<br>

ğŸª› `distinct()`: _Filtra y mantiene solo filas Ãºnicas segÃºn variables especÃ­ficas._

```{r}
### Procesamiento (elimino duplicados)
df_ingresos_trab <- df_ingresos_trab %>% 
  distinct()

### Chequeo
df_ingresos_trab %>% 
  get_dupes()
```

## Procesamiento de datos

<br>
<br>

Â¿Y si considero un caso "duplicado" sÃ³lo por dos de sus variables?



## Procesamiento de datos

<br>

ğŸª› `pull()`: _Extrae una columna como vector, facilitando ciertas operaciones._

```{r}
# Obtener vector con todos los ingresos anuales, en modo tidyverse
vec_ingresos <- df_ingresos_trab |> 
  filter(ciudad_residencia == "Puebla") %>% 
  pull(ingreso_anual)

mean(vec_ingresos, na.rm = TRUE)

```


## Procesamiento de datos

<br>

ğŸª› `pull()`: _Extrae una columna como vector, facilitando ciertas operaciones._

```{r}
# Obtener vector con todos los ingresos anuales, en modo tidyverse
valor_ingreso_max_puebla <- df_ingresos_trab |> 
  filter(ciudad_residencia == "Puebla") %>% 
  filter(ingreso_anual == max(ingreso_anual, na.rm = TRUE)) %>% 
  pull(ingreso_anual)

valor_ingreso_max_puebla

```


## Procesamiento de datos

<br> 

> El ingreso mÃ¡ximo de la ciudad de Pueba es de **$`r format(valor_ingreso_max_puebla, big.mark = ".", decimal.mark = ",")`**


```{r}
# El ingreso mÃ¡ximo de la ciudad de Pueba es de 
# **$`r format(valor_ingreso_max_puebla, big.mark = ".", decimal.mark = ",")`**

```


## Procesamiento de datos

<br>

ğŸª› `dplyr::coalesce()`: _Ayuda a manejar valores faltantes reemplazÃ¡ndolos con valores especÃ­ficos._



## Procesamiento de datos

::: panel-tabset

### DiagnÃ³stico
```{r}
# Chequeo valores NA en columna `ingreso_anual`
df_ingresos_trab %>% 
  count(
    "valores NA" = is.na(ingreso_anual)
    )
```

### Procesamiento
```{r}
# Reemplazo NA por ceros
df_ingresos_trab <- df_ingresos_trab %>% 
  mutate(
    ingreso_anual = coalesce(ingreso_anual, 0)
    )
```

### Chequeo

```{r}
# Chequeo valores NA en columna `ingreso_anual`
df_ingresos_trab %>% 
  count(
    "valores NA" = is.na(ingreso_anual)
    )
```

:::



## Procesamiento de datos

<br>

ğŸª› `dplyr::na_if()`: _Convierte valores especÃ­ficos (por ejemplo valores errÃ³neos) a NA._

-->  Ãštil cuando ciertos cÃ³digos o textos (como "NS/NC" o "Sin dato") significan dato faltante.


## `na_if()`

âœ… Ejemplo 1 â€” Texto "NS/NC" â†’ NA

```{r}
### DiagnÃ³stico

df_ingresos_trab %>% 
  count(nivel_educativo)
```

## `na_if()`

âœ… Ejemplo 1 â€” Texto "NS/NC" â†’ NA

```{r}
### Procesamiento

df_ingresos_trab <- df_ingresos_trab %>% 
  mutate(nivel_educativo = na_if(nivel_educativo, "NS/NC"))
```


## `na_if()`

âœ… Ejemplo 1 â€” Texto "NS/NC" â†’ NA

```{r}
### Chequeo

df_ingresos_trab %>% 
  count(nivel_educativo)
```

## `na_if()`

âœ… Ejemplo 1â€” Texto "NS/NC"  y "Sin dato" â†’ NA

```{r}
### DiagnÃ³stico

df_ingresos_trab %>% 
  count(nivel_educativo)
```


## ğŸ“¦ La familia de funciones `slice()` {.smaller}

<br>


| FunciÃ³n          | Â¿QuÃ© hace?                                                                  |
|------------------|-----------------------------------------------------------------------------|
| `slice_head()`   | _Devuelve las primeras `x` filas del data frame (o de cada grupo si se usa `group_by()`)._ |
| `slice_tail()`   | _Devuelve las Ãºltimas `x` filas del data frame (o de cada grupo)._           |
| `slice_min()`    | _Devuelve las filas con los valores **mÃ­nimos** de la columna `col`._        |
| `slice_max()`    | _Devuelve las filas con los valores **mÃ¡ximos** de la columna `col`._        |
| `slice_sample()` | _Selecciona `x` filas de forma aleatoria (Ãºtil para crear muestras)._     |


## ğŸ“¦ La familia de funciones `slice()` {.smaller}


```{r}
library(dplyr)

df_ingresos_trab |> 
  slice_min(
    ingreso_anual,
    by = ciudad_residencia)
```

## ğŸ“¦ La familia de funciones `slice()` {.smaller}

<br>

Â¿Y quÃ© pasa si usamos los parÃ¡metros `with_ties = TRUE` y `n =`?

```{r}
#| eval: false

df_ingresos_trab |> 
  slice_min(
    ingreso_anual,
    by = ciudad_residencia,
    with_ties = TRUE,
    n = 2)
```

## ğŸ“¦ La familia de funciones `slice()` {.smaller}

<br>

Â¿Y quÃ© pasa si usamos los parÃ¡metros `with_ties = TRUE` y `n =`?

```{r}
#| eval: false

df_ingresos_trab |> 
  slice_min(
    ingreso_anual,
    by = ciudad_residencia,
    with_ties = TRUE,
    n = 2)
```


## ğŸ“¦ La familia de funciones `slice()` {.smaller}

<br>

- ğŸ§  Extra: Â¿cuÃ¡ndo usar slice() y no filter()?

- âœ”ï¸ Cuando se quiere trabajar por posiciÃ³n y no por condiciÃ³n lÃ³gica.

- âœ”ï¸ Cuando se necesita una muestra o los valores extremos por grupo.

- âŒ Si se necesita filtrar por edad, provincia o texto, usar filter().


## ğŸ”„ De ancho a largo y de largo a ancho

<br>

Funciones `pivot_longer()` y `pivot_wider()`



## Â¿QuÃ© es pivotear una tabla? {.smaller}

<br>

  > Pivotear significa reorganizar columnas en filas o filas en columnas, sin perder informaciÃ³n.

ğŸ” Es una transformaciÃ³n estructural, no de contenido.

ğŸŸ¦ Formato ancho: muchas columnas â†’ 1 fila por caso

ğŸŸ¥ Formato largo: menos columnas â†’ varias filas por caso


## ğŸ”„ De ancho a largo y de largo a ancho

::: columns
::: {.column width="50%"}
![](../img/dato_ancho.png)
:::

::: {.column width="50%"}
![](../img/dato_largo.png)
:::
:::


## `pivot_longer()` â€“ de ancho a largo

<br>

```{r}
head(df_ingresos_trab)
```

## `pivot_longer()` â€“ de ancho a largo

<br>

```r
pivot_longer(data,
             cols = columnas_a_pivotear,
             names_to = "nombre_nueva_columna",
             values_to = "nombre_valores")
```

## `pivot_longer()` â€“ de ancho a largo

```{r}
ventas <- tibble(
  producto = c("A", "B"),
  enero = c(100, 200),
  febrero = c(150, 250)
)

head(ventas)
```


## `pivot_longer()` â€“ de ancho a largo

<br>

```{r}
### Cargo librerÃ­a
library(tidyr)

ventas |> 
  pivot_longer(cols = enero:febrero,
               names_to = "mes",
               values_to = "ventas")

```


